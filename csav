#!/bin/bash

# Configurable variables
# readonly config_checkout_path="$HOME"
# readonly repository_name="configs"
# readonly repository_url="https://github.com/<user_name>/$repository_name"
# readonly jump_terminal_command='alacritty --working-directory "$(config_root_path)" &'

print_error()
{
  echo "csav: $1"
}

config_root_path()
{
  echo "$config_checkout_path/$repository_name"
}

enforce_initialization()
{
  if [[ ! -d $(config_root_path)/.git ]]
  then
    print_error "init required, not a git repository: '$(config_root_path)'"
    echo "  use \"csav init\" to clone the repository"
    exit 1
  fi
}

help()
{
  # TODO Implement displaying usage.
  echo "help"
}

init()
{
  if [[ -d $(config_root_path)/.git ]]
  then
    echo "initialized"
    return 0
  fi

  mkdir -p "$(config_root_path)"

  if [[ $? -ne 0 ]]
  then
    print_error "directory creation failed -- '$(config_root_path)'"
    exit 1
  fi

  git clone "$repository_url" "$(config_root_path)"

  if [[ $? -ne 0 ]]
  then
    rm -rf "$(config_root_path)"
    print_error "repository cloning failed -- '$repository_url'"
    exit 1
  fi

  echo "initialized"
}

add()
{
  enforce_initialization

  for path in "$@"
  do
    if [[ $path =~ ~* ]]
    then
      home_expansion="echo \"$path\" | sed 's|~|$HOME|'"
      path=$(eval "$home_expansion")
    fi
    
    cp -r --parent "$(realpath "$path")" "$(config_root_path)"
  done
  
  cd "$(config_root_path)"
  git add *
}

addcomm()
{
  add "$@"
  commit
}

restore()
{
  enforce_initialization
  cd "$(config_root_path)"
  git restore --staged *
  git clean -dfx
}

commit()
{
  enforce_initialization
  cd "$(config_root_path)"
  git commit -m "$(date)"
}

pull()
{
  enforce_initialization
  cd "$(config_root_path)"
  git pull
}

push()
{
  enforce_initialization
  cd "$(config_root_path)"
  git push
}

diff()
{
  enforce_initialization
  cd "$(config_root_path)"
  git diff "$@"
}

jump()
{
  enforce_initialization

  if [[ -z $jump_terminal_command ]]
  then
    print_error "can not jump to '$(config_root_path)', 'jump_terminal_command' variable must be set"
    exit 1
  fi

  eval "$jump_terminal_command"
}

if [[ -z $config_checkout_path ]]
then
  print_error "'config_checkout_path' variable must be set"
  exit 1
fi

if [[ -z $repository_name ]]
then
  print_error "'repository_name' variable must be set"
  exit 1
fi

if [[ -z $repository_url ]]
then
  print_error "'repository_url' variable must be set"
  exit 1
fi

readonly command="$1"

case "$command" in
  help | init | add | addcomm | restore | commit | pull | push | diff | jump)
    shift
    eval "$command $@"
    ;;
  "")
    print_error "no operation specified (use 'help' for help)"
    ;;
  *)
    print_error "invalid operation -- '$1'"
    ;;
esac